---
title: "Plotting heat trees"
bibliography: bibliography.bibtex
---

```{r init, echo = FALSE, message = FALSE}
library(knitr)
if (! is.null(current_input())) { # if knitr is being used
  knitr::read_chunk("settings.R")
} else {
  source("settings.R")
}
```

```{r rendering_settings, echo = FALSE, warning=FALSE, message=FALSE}
```

## Introduction

Visualizing statistics associated with hierarchical information can be difficult. 
In the case of organism abundance data calssified by a taxonomy, stacked barcharts or pie graphs are typically used to view a single rank in the taxonomy (e.g. phylum).
The use of color to represent different taxa in these visulizations limits the number of taxa displayed to the number of colors that can be easily discerned.
Metacoder provides an alternative visulization we call *heat trees* to plot this type of data. 

## Basic usage

Although there are many options that can be used to make highly customized graphs, `heat_tree` only needs one argument to function: an object of type `taxmap`.
We can see the default appearance of a subset of the UNITE database [@koljalg2005unite] using the code below:

```{r}
library(metacoder)
unite_ex_data_3
heat_tree(unite_ex_data_3)
```

Each node (i.e. circle) in the graph represents a taxon and each line represents its membership in a taxon of a corser taxonomic rank. 

### Node/Line size

The size of nodes and edges can be scaled to any number associated with each taxon using the `node_size` and `edge_size` parameters. 
Below, the number of sequences for each taxon is used to determine node size.

```{r}
heat_tree(unite_ex_data_3,
          node_size = n_obs)
```

Note that it was not necessary to specify the absolute node size; the range of absolute node sizes is optimized for each graph so as to minimize overlap of nodes and maximize the ranges of sizes.
The argument `overlap_avoidance` is used to determine how much overlaps are avoided. 
Higher values mean more importance is given to avoiding overlapping nodes than to maximizing the ranges of sizes.
A high `overlap_avoidance` makes the connections between taxa more clear, but diminishes the visual effect of node size.
Too low of an `overlap_avoidance` can make the graph hard to read by allowing nodes to overlap more.

```{r}
heat_tree(unite_ex_data_3,
          node_size = n_obs,
          overlap_avoidance = 10)
heat_tree(unite_ex_data_3,
          node_size = n_obs,
          overlap_avoidance = 0.1)
```


### Node color

The `node_color` argument works in a similar way to `node_size`.
Numeric values are translated to a range of colors.
Below the abundance of samples for each taxon is used to determine color instead of size.
The range of color used can be set using the `node_color_range` argument. 
This argument take a list of colors in the form of names, hex color codes, or integers. 

```{r}
heat_tree(unite_ex_data_3,
          node_size = n_obs,
          node_color = n_obs)

heat_tree(unite_ex_data_3,
          node_size = n_obs,
          node_color = n_obs,
          node_color_range = c("#FFFFFF", "darkorange3", "#4e567d", "gold"))
```

### Line color

Like `node_size`, the color of lines can be set independently of nodes, although the default behavior is for the lines to have the same color as the nodes. 
To only color nodes, you can set the lines to be a constant color or vise-versa.

```{r}
heat_tree(unite_ex_data_3,
          node_size = n_obs,
          node_color = n_obs,
          edge_color = "grey")

heat_tree(unite_ex_data_3,
          node_size = n_obs,
          node_color = "grey",
          edge_color = n_obs)
```

You can also set the color palette used for the lines in the same way as you set it for the node using the argument `edge_color_range`. 

### Node labels 

Labels can be added to nodes using the `node_label` option:

```{r}
heat_tree(unite_ex_data_3,
          node_size = n_obs,
          node_color = n_obs,
          node_label = name)
```

Label sizes are proportional to node size by default. 
By default, only a maximum number of labels are printed to avoid excessive crowding. 
The maximum number of labels that will be printed is controlled by the `node_label_max` option:

```{r}
heat_tree(unite_ex_data_3,
          node_size = n_obs,
          node_color = n_obs,
          node_label = name,
          node_label_max = 5)

heat_tree(unite_ex_data_3,
          node_size = n_obs,
          node_color = n_obs,
          node_label = name,
          node_label_max = 200)
```

Note that the labels are a special kind that scales with the size of the graph. 
This means that the text size will always be proportional to the graph size regardless of how big the graph is rendered; however, these special labels take more time to render, so causing too many to be printed drastically slow the rendering of the graph or even cause errors. 

### Line labels 

Lines can be labeled as well using the `edge_label` option, which works similarly to the `node_label` option:

```{r}
heat_tree(unite_ex_data_3,
          node_size = n_obs,
          node_color = n_obs,
          edge_label = name)
```


### Background color

The default background color is transparent in order to make formatting posters and slideshows as flexible as possible.
Other background colors can be specified using the `background_color` option:

```{r}
heat_tree(unite_ex_data_3,
          node_size = n_obs,
          node_color = n_obs,
          background_color = "grey")
```


Plots can be saved using `ggsave` from the `ggplot2` package or using the `output_file` option:

```{r, eval = FALSE}
my_plot <- heat_tree(unite_ex_data_3,
                     node_size = n_obs,
                     node_color = n_obs)
ggplot2::ggsave("path/to/my/output.png", my_plot, bg = "transparent")
```

```{r, eval = FALSE}
heat_tree(unite_ex_data_3,
          node_size = n_obs,
          node_color = n_obs,
          output_file = "path/to/my/output.png")
```


## Usage examples

### Plotting with multiple taxonomy roots

Sometimes a taxonomy has multiple roots.
This occurs when there is not a common taxon all observations are assigned to, like "Eukaryota", if all your observations are associated with eukayotes.
`metacoder` plots taxonomies with multiple roots as multiple trees:

```{r}
heat_tree(contaminants,
          node_size = n_obs,
          node_color = n_obs,
          node_label = name,
          tree_label = name,
          layout = "fruchterman-reingold")
```


### More information

To see the long list of available plotting options, type `?heat_tree`.
Although there are many options (perhaps an overwhleming amount at first glance), most of the options fall into groups that work in similar ways.

## Software and packages used

```{r}
sessionInfo()
```

## References