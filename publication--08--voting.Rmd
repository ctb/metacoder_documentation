---
title: Graphing voting geography
---

```{r voting_setup, echo=FALSE, warning=FALSE, message=FALSE, cache=FALSE}
knitr::read_chunk("settings.R")
```

```{r rendering_settings, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE}
```

```{r io_settings, echo = FALSE, warning=FALSE, message=FALSE, cache=FALSE}
```

## Read in data

```{r}
file_path <- file.path(input_folder, "primary_results.csv")
data <- tibble::as_tibble(read.table(file_path, sep = ",", header = TRUE, quote = "", stringsAsFactors = FALSE))
```

## Add region column

```{r}
divisions <- stack(list("New England" = c("Connecticut", "Maine", "Massachusetts",
                                          "New Hampshire", "Rhode Island", "Vermont"),
                        "Mid-Atlantic" = c("New Jersey", "New York", "Pennsylvania"),
                        "NE Central" = c("Illinois", "Indiana", "Michigan", "Ohio", "Wisconsin"),
                        "NW Central" = c("Iowa", "Kansas", "Minnesota", "Missouri",
                                         "Nebraska", "North Dakota", "South Dakota"),
                        "South Atlantic" = c("Delaware", "Florida", "Georgia", "Maryland",
                                             "North Carolina", "South Carolina", "Virginia",
                                             "Washington D.C.", "West Virginia"),
                        "SE Central" = c("Alabama", "Kentucky", "Mississippi", "Tennessee"),
                        "SW Central" = c("Arkansas", "Louisiana", "Oklahoma", "Texas"),
                        "Mountain" = c("Arizona", "Colorado", "Idaho", "Montana", "Nevada",
                                       "New Mexico", "Utah", "Wyoming"),
                        "Pacific" = c("Alaska", "California", "Hawaii", "Oregon", "Washington")))
data$division <- divisions$ind[match(data$state, divisions$values)]
regions <- stack(list("Northeast" = c("New England", "Mid-Atlantic"),
                      "Midwest" = c("NE Central", "NW Central"),
                      "South" = c("South Atlantic", "SE Central", "SW Central"),
                      "West" = c("Mountain", "Pacific")))
data$region <- regions$ind[match(data$division, regions$values)]
data[] <- lapply(data, as.character)
```


## Create and parse classifications

The code below creates a single column in the data set that contains all of the levels of the geographic hierarchy for each location. 
It is then parsed using `parse_taxonomy_table` so that the other columns are preserved in the `taxmap` object.

```{r}
library(metacoder)
data$classification <- paste(sep = "|", "USA", data$region, data$division, data$state, data$county)
voting_data <- parse_taxonomy_table(input = data, taxon_col = c("class" = -1), other_col_type = "obs_info", class_sep = "\\|")
```

## Get canidate vote counts

```{r}
voting_data <- mutate_taxa(voting_data,
                           total_votes = sapply(obs(voting_data),
                                                function(i) sum(voting_data$obs_data$votes[i])),
                           clinton_votes = sapply(obs(voting_data),
                                                  function(i) {
                                                    subset <- voting_data$obs_data[i, ]
                                                    sum(subset$votes[subset$candidate == "Hillary Clinton"])
                                                  }),
                           sanders_votes = sapply(obs(voting_data),
                                                  function(i) {
                                                    subset <- voting_data$obs_data[i, ]
                                                    sum(subset$votes[subset$candidate == "Bernie Sanders"])
                                                  })
)
```

# Get top counties

I will get a list of the "taxon" IDs for the county in each state with the most votes.
The code below works, but is not too elegant; I want to make a new set of functions, maybe called something like `subtaxa_apply` to do this kind of operation. 

```{r}
total_votes <- taxon_data(voting_data, col_subset = "total_votes", drop = TRUE)
top_counties <- vapply(FUN.VALUE = character(1), 
                       subtaxa(voting_data, index = TRUE,
                               filter_taxa(voting_data,
                                           n_supertaxa == 3)$taxon_data$taxon_ids), 
                       function(x) voting_data$taxon_data$taxon_ids[x[which.max(total_votes[x])]])
```

## Plotting results


```{r}
voting_data %>%
  heat_tree(node_size = total_votes,
            node_size_range = c(0.0002, 0.06),
            node_color = (clinton_votes - sanders_votes) / total_votes * 100,
            edge_label = ifelse(taxon_ids %in% top_counties | n_supertaxa <= 3, name, NA),
            edge_label_size_trans = "area",
            edge_label_size_range = c(0.008, 0.025),
            node_color_range = c("#a6611a", "lightgray", "#018571"),
            node_color_interval = c(-50, 50),
            edge_color_range = c("#a6611a", "lightgray", "#018571"),
            edge_color_interval = c(-50, 50),
            node_color_axis_label = "Clinton                                Sanders",
            node_size_axis_label = "Total votes",
            edge_label_max = 5000, 
            overlap_avoidance = 10,
            output_file = file.path(output_folder,
                                    paste0("voting",
                                           output_format)))
```

